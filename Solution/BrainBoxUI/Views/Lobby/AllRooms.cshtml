@using SharedModels.Question
@model List<RoomDTO>
@{
    ViewData["Title"] = "Available rooms";
}

@section Stylesheets {

}

@section Scripts {
    <script>
        document.getElementById("joinButton").addEventListener("click", function () {
            var joinCode = document.getElementById("joinCode").value;
            var messageField = document.getElementById("messageField");
            if (joinCode) {
                // Retrieve the token from the cookie
                var token = getCookie("BearerToken");

                fetch(`https://localhost:7016/api/Lobby/JoinRoom/${joinCode}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        // Check Content-Type before trying to parse as JSON
                        var contentType = response.headers.get('Content-Type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            return response.text(); // handle non-JSON response
                        }
                    })
                    .then(data => {
                        // Handle the success response
                        if (typeof data === 'object') {
                            messageField.innerText = `User joined the room successfully: ${JSON.stringify(data)}`;
                        } else {
                            messageField.innerText = `Non-JSON response: ${data}`;
                        }
                    })
                    .catch(error => {
                        // Handle the error
                        messageField.innerText = `Error joining room: ${error.message}`;
                    });
            }
        });

        function getCookie(name) {
            var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            if (match) return match[2];
        }
    </script>
}

<div>
    <a asp-area="" asp-controller="Lobby" asp-action="CreateRoom" class="btn btn-secondary">Create new room</a>
    <input type="text" id="joinCode" placeholder="Enter code" />
    <button id="joinButton" class="btn btn-primary">Join</button>
    <div id="messageField"></div>

    <ul>
        @foreach (RoomDTO room in Model)
        {
            <li>
               <a class="nav-link text-dark" asp-area="" asp-controller="Lobby" asp-action="Room" asp-route-roomId="@room.Id">@room.Name</a>
                @* <a class="nav-link text-dark" onclick="navigateToRoom('@room.Id')"> @room.Name </a> *@
            </li>
        }
    </ul>
</div>

@* <script>
    function navigateToRoom(roomId) {
        var token = document.cookie.replace(/(?:(?:^|.*;\s*)BearerToken\s*=\s*([^;]*).*$)|^.*$/, "$1");

        // Check if the token is available
        if (token) {
            // Add the token to the request header
            var headers = new Headers();
            headers.append('Authorization', 'Bearer ' + token);

            // Make the request to the Room action
            fetch(`/Lobby/Room/${roomId}`, {
                method: 'GET',
                headers: headers
            })
            .then(response => response.text())
            .then(data => {
                // Process the response data as needed
                console.log(data);
            })
            .catch(error => {
                // Handle errors
                console.error('Error:', error);
            });
        } else {
            // Handle the case where the token is not available
            console.error('BearerToken cookie not found.');
        }
    }
</script> *@
